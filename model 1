using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;

namespace NTWarriors
{
    class Carta
    {
        public string Nome { get; set; }
        public string Tipo { get; set; }
        public string Elemento { get; set; }
        public int Energia { get; set; } // Usada para atacar ou habilidades
        public int Poder { get; set; }
        public int Resistencia { get; set; }
        public List<Habilidade> Habilidades { get; set; }
        public bool PodeAtacar { get; set; } // Lacaios não podem atacar

        public Carta(string nome, string tipo, string elemento, int energia, int poder, int resistencia, List<Habilidade> habilidades)
        {
            Nome = nome;
            Tipo = tipo;
            Elemento = elemento;
            Energia = energia;
            Poder = poder;
            Resistencia = resistencia;
            Habilidades = habilidades ?? new List<Habilidade>();
            PodeAtacar = false; // Lacaios não podem atacar
        }

        public void Destruir()
        {
            Resistencia = 0;
            Poder = 0;
        }
    }

    class Habilidade
    {
        public string Nome { get; set; }
        public string Tipo { get; set; }
        public string Descricao { get; set; }
        public Action<Jogador, Jogador> Ativar { get; set; }
    }

    class Jogador
    {
        public string Nome { get; set; }
        public int EnergiaTotal { get; set; }
        public List<Carta> Mao { get; set; }
        public List<Carta> DeckPrincipal { get; set; }
        public List<Carta> DeckHerois { get; set; }
        public List<Carta> CampoSuperior { get; set; }
        public Carta HeroiAtivo { get; set; }
        public Carta HeroiSuporte { get; set; }
        public static List<Carta> Sucata { get; set; } = new List<Carta>();
        public int HeroisDestruídos { get; set; } = 0;

        public Jogador(string nome, List<Carta> deckPrincipal, List<Carta> deckHerois)
        {
            Nome = nome;
            EnergiaTotal = 10;
            Mao = new List<Carta>();
            DeckPrincipal = deckPrincipal;
            DeckHerois = deckHerois;
            CampoSuperior = new List<Carta>();

            EmbaralharDeck(DeckPrincipal);
            EmbaralharDeck(DeckHerois);

            for (int i = 0; i < 3; i++)
            {
                ComprarCarta(DeckPrincipal);
                ComprarCarta(DeckHerois);
            }
        }

        private void EmbaralharDeck(List<Carta> deck)
        {
            Random rng = new Random();
            for (int i = deck.Count - 1; i > 0; i--)
            {
                int j = rng.Next(i + 1);
                (deck[i], deck[j]) = (deck[j], deck[i]);
            }
        }

        public void ComprarCarta(List<Carta> deck)
        {
            if (deck.Count > 0)
            {
                Mao.Add(deck[0]);
                deck.RemoveAt(0);
            }
        }

        public void JogarCarta(Carta carta)
        {
            if (Mao.Contains(carta))
            {
                // Verifica se a carta é do tipo Ação ou Equipamento
                if (carta.Tipo == "Ação" || carta.Tipo == "Equipamento")
                {
                    if (EnergiaTotal >= carta.Energia)
                    {
                        Mao.Remove(carta);
                        EnergiaTotal -= carta.Energia; // Gasta energia apenas para ações/equipamentos
                    }
                    else
                    {
                        Console.WriteLine("Energia insuficiente para jogar esta carta!");
                        return;
                    }
                }
                else
                {
                    Mao.Remove(carta); // Heróis e lacaios não gastam energia para serem jogados
                }

                if (carta.Tipo == "Herói")
                {
                    if (HeroiAtivo == null && !CampoSuperior.Any(c => c.Nome == carta.Nome))
                    {
                        HeroiAtivo = carta;
                    }
                    else if (HeroiSuporte == null && !CampoSuperior.Any(c => c.Nome == carta.Nome))
                    {
                        HeroiSuporte = carta;
                    }
                    else
                    {
                        Console.WriteLine("Você já tem dois heróis em campo ou herói repetido.");
                    }
                }
                else if (carta.Tipo == "Lacaio")
                {
                    if (CampoSuperior.Count < 5)
                    {
                        CampoSuperior.Add(carta);
                    }
                    else
                    {
                        Console.WriteLine("Não é possível adicionar mais lacaios. Já existem 5 lacaios no campo.");
                    }
                }
                else if (carta.Tipo == "Ação" || carta.Tipo == "Equipamento")
                {
                    // Lógica para ativar ações ou equipamentos
                    Console.WriteLine($"{carta.Nome} foi jogada com sucesso!");
                }
            }
            else
            {
                Console.WriteLine("Carta não encontrada na mão!");
            }
        }

        public void Atacar(Jogador adversario)
        {
            if (HeroiAtivo != null && CampoSuperior.Count > 0)
            {
                // Verifica se o jogador tem energia suficiente para atacar com o herói ativo
                if (EnergiaTotal >= HeroiAtivo.Energia)
                {
                    EnergiaTotal -= HeroiAtivo.Energia; // Gasta energia para atacar

                    int dano = HeroiAtivo.Poder;
                    Console.WriteLine($"{Nome} atacou com {HeroiAtivo.Nome} causando {dano} de dano!");

                    // Jogador defensor escolhe como bloquear o dano
                    List<Carta> lacaiosUsados = adversario.EscolherLacaiosParaDefesa(dano);

                    // Aplicar dano restante ao herói ativo do adversário
                    if (dano > 0 && adversario.HeroiAtivo != null)
                    {
                        adversario.HeroiAtivo.Resistencia -= dano;
                        Console.WriteLine($"{adversario.HeroiAtivo.Nome} sofreu {dano} de dano!");

                        if (adversario.HeroiAtivo.Resistencia <= 0)
                        {
                            Sucata.Add(adversario.HeroiAtivo);
                            adversario.HeroiAtivo = null;
                            adversario.HeroisDestruídos++;

                            Console.WriteLine($"{adversario.Nome} perdeu um herói! Sacando um novo herói...");
                            adversario.SacarNovoHeroi();
                        }
                    }

                    // Lacaios contra-atacam
                    foreach (var lacaio in adversario.CampoSuperior.ToList())
                    {
                        if (lacaio.Resistencia > 0)
                        {
                            HeroiAtivo.Resistencia -= lacaio.Poder;
                            Console.WriteLine($"{lacaio.Nome} contra-atacou {HeroiAtivo.Nome}, reduzindo {lacaio.Poder} de resistência!");

                            if (HeroiAtivo.Resistencia <= 0)
                            {
                                Sucata.Add(HeroiAtivo);
                                HeroiAtivo = null;
                                HeroisDestruídos++;

                                Console.WriteLine($"{Nome} perdeu um herói! Sacando um novo herói...");
                                SacarNovoHeroi();
                                break;
                            }
                        }
                    }
                }
                else
                {
                    Console.WriteLine("Energia insuficiente para atacar!");
                }
            }
        }

        public List<Carta> EscolherLacaiosParaDefesa(int dano)
        {
            List<Carta> lacaiosUsados = new List<Carta>();
            Console.WriteLine($"{Nome}, você está sofrendo um ataque de {dano} de dano!");

            while (dano > 0 && CampoSuperior.Count > 0)
            {
                Console.WriteLine("Escolha um lacaio para bloquear o dano (ou digite 0 para parar):");
                for (int i = 0; i < CampoSuperior.Count; i++)
                {
                    Console.WriteLine($"{i + 1}. {CampoSuperior[i].Nome} (Resistência: {CampoSuperior[i].Resistencia})");
                }

                int escolha;
                bool entradaValida = int.TryParse(Console.ReadLine(), out escolha);

                if (entradaValida && escolha >= 1 && escolha <= CampoSuperior.Count)
                {
                    Carta lacaioEscolhido = CampoSuperior[escolha - 1];
                    lacaiosUsados.Add(lacaioEscolhido);

                    if (lacaioEscolhido.Resistencia >= dano)
                    {
                        lacaioEscolhido.Resistencia -= dano;
                        dano = 0;
                        Console.WriteLine($"{lacaioEscolhido.Nome} bloqueou todo o dano!");
                    }
                    else
                    {
                        dano -= lacaioEscolhido.Resistencia;
                        lacaioEscolhido.Resistencia = 0;
                        Console.WriteLine($"{lacaioEscolhido.Nome} foi destruído!");
                        Sucata.Add(lacaioEscolhido);
                        CampoSuperior.Remove(lacaioEscolhido);
                    }
                }
                else if (escolha == 0)
                {
                    break;
                }
                else
                {
                    Console.WriteLine("Escolha inválida. Tente novamente.");
                }
            }

            return lacaiosUsados;
        }

        public void SacarNovoHeroi()
        {
            if (DeckHerois.Count > 0)
            {
                var novoHeroi = DeckHerois[0];
                DeckHerois.RemoveAt(0);
                Mao.Add(novoHeroi);
                Console.WriteLine($"{Nome} sacou um novo herói: {novoHeroi.Nome}");
            }
        }

        public void VerificarHeróisNoCampo()
        {
            if ((HeroiAtivo == null || HeroiSuporte == null) && DeckHerois.Count > 0)
            {
                Console.WriteLine($"{Nome} não tem dois heróis no campo! Escolha um herói para colocar em campo.");
                SacarNovoHeroi();
                if (HeroiAtivo == null)
                {
                    HeroiAtivo = Mao.First(c => c.Tipo == "Herói");
                    Mao.Remove(HeroiAtivo);
                }
                else if (HeroiSuporte == null)
                {
                    HeroiSuporte = Mao.First(c => c.Tipo == "Herói");
                    Mao.Remove(HeroiSuporte);
                }
            }
        }

        public bool VerificarDerrota()
        {
            return HeroisDestruídos >= 3; // Verifica se 3 heróis foram destruídos
        }

        public void MostrarCampo()
        {
            Console.WriteLine($"Campo de {Nome}:");
            Console.WriteLine($"- Fileira Superior (Lacaios): {string.Join(", ", CampoSuperior.Select(c => c.Nome))}");
            Console.WriteLine($"- Herói Ativo (Meio): {HeroiAtivo?.Nome ?? "Nenhum"}");
            Console.WriteLine($"- Herói Suporte (Inferior): {HeroiSuporte?.Nome ?? "Nenhum"}");
        }

        public void RecuperarEnergia()
        {
            EnergiaTotal += 2; // Recupera 2 pontos de energia por turno
            Console.WriteLine($"{Nome} recuperou 2 pontos de energia. Energia total: {EnergiaTotal}");
        }

        public static void MostrarSucata()
        {
            Console.WriteLine($"Sucata: {string.Join(", ", Sucata.Select(c => c.Nome))}");
        }
    }

    class Program
    {
        static void Main(string[] args)
        {
            // Exemplo de decks com heróis, lacaios, ações e equipamentos
            List<Carta> deck1 = new List<Carta>
            {
                new Carta("Mega Man", "Herói", "Neutro", 2, 3000, 2500, null), // Energia = 2 (para atacar)
                new Carta("Mega Man - Suporte", "Herói", "Neutro", 1, 1000, 1000, null), // Energia = 1 (para atacar)
                new Carta("Lacaio 1", "Lacaio", "Neutro", 1, 500, 1000, null), // Poder = 500 (para contra-atacar)
                new Carta("Lacaio 2", "Lacaio", "Neutro", 1, 600, 1200, null), // Poder = 600 (para contra-atacar)
                new Carta("Ataque Poderoso", "Ação", "Neutro", 3, 0, 0, null), // Energia = 3 (custo para jogar)
                new Carta("Escudo de Energia", "Equipamento", "Neutro", 2, 0, 0, null) // Energia = 2 (custo para jogar)
            };
            List<Carta> deck2 = new List<Carta>
            {
                new Carta("Proto Man", "Herói", "Fogo", 2, 2500, 2000, null), // Energia = 2 (para atacar)
                new Carta("Proto Man - Suporte", "Herói", "Fogo", 1, 1000, 1000, null), // Energia = 1 (para atacar)
                new Carta("Lacaio 3", "Lacaio", "Fogo", 1, 500, 1200, null), // Poder = 500 (para contra-atacar)
                new Carta("Lacaio 4", "Lacaio", "Fogo", 1, 600, 1100, null), // Poder = 600 (para contra-atacar)
                new Carta("Ataque Flamejante", "Ação", "Fogo", 3, 0, 0, null), // Energia = 3 (custo para jogar)
                new Carta("Escudo de Fogo", "Equipamento", "Fogo", 2, 0, 0, null) // Energia = 2 (custo para jogar)
            };

            Jogador jogador1 = new Jogador("Jogador 1", deck1, deck1);
            Jogador jogador2 = new Jogador("Jogador 2", deck2, deck2);

            bool jogoAtivo = true;
            int turno = 1;

            // Fase de colocar heróis em campo
            Console.WriteLine($"{jogador1.Nome}, escolha 2 heróis para colocar em campo:");
            jogador1.MostrarCampo();
            jogador1.JogarCarta(jogador1.Mao.First(c => c.Tipo == "Herói"));
            jogador1.JogarCarta(jogador1.Mao.First(c => c.Tipo == "Herói"));

            Console.WriteLine($"{jogador2.Nome}, escolha 2 heróis para colocar em campo:");
            jogador2.MostrarCampo();
            jogador2.JogarCarta(jogador2.Mao.First(c => c.Tipo == "Herói"));
            jogador2.JogarCarta(jogador2.Mao.First(c => c.Tipo == "Herói"));

            while (jogoAtivo)
            {
                Jogador jogadorAtual = (turno % 2 == 1) ? jogador1 : jogador2;
                Jogador jogadorAdversario = (turno % 2 == 1) ? jogador2 : jogador1;

                Console.Clear();
                Console.WriteLine($"Turno {turno} - {jogadorAtual.Nome}'s vez!");

                // Recuperar energia no início do turno
                jogadorAtual.RecuperarEnergia();

                // Comprar uma carta no início do turno
                jogadorAtual.ComprarCarta(jogadorAtual.DeckPrincipal);

                // Verificar se o jogador tem 2 heróis no campo
                jogadorAtual.VerificarHeróisNoCampo();

                // Mostrar o campo atual de cada jogador
                jogadorAtual.MostrarCampo();
                jogadorAdversario.MostrarCampo();

                // Jogador decide as ações: atacar ou jogar uma carta
                Console.WriteLine("\nO que você quer fazer?");
                Console.WriteLine("1. Atacar");
                Console.WriteLine("2. Jogar uma carta");
                Console.Write("Escolha: ");
                string escolha = Console.ReadLine();

                if (escolha == "1")
                {
                    jogadorAtual.Atacar(jogadorAdversario);
                }
                else if (escolha == "2")
                {
                    Console.WriteLine("Escolha uma carta para jogar:");
                    for (int i = 0; i < jogadorAtual.Mao.Count; i++)
                    {
                        Console.WriteLine($"{i + 1}. {jogadorAtual.Mao[i].Nome}");
                    }

                    int cartaEscolhida;
                    bool entradaValida = int.TryParse(Console.ReadLine(), out cartaEscolhida);
                    if (entradaValida && cartaEscolhida >= 1 && cartaEscolhida <= jogadorAtual.Mao.Count)
                    {
                        jogadorAtual.JogarCarta(jogadorAtual.Mao[cartaEscolhida - 1]);
                    }
                    else
                    {
                        Console.WriteLine("Escolha inválida.");
                    }
                }

                // Verificar o estado do jogo
                if (jogadorAdversario.VerificarDerrota())
                {
                    Console.WriteLine($"{jogadorAdversario.Nome} perdeu o jogo!");
                    Console.WriteLine($"{jogadorAtual.Nome} venceu em {turno} turnos!");
                    jogoAtivo = false;
                }

                turno++;
                Thread.Sleep(2000); // Espera de 2 segundos para o próximo turno
            }

            Console.WriteLine("Fim do jogo!");
        }
    }
}

            Console.WriteLine("Fim do jogo!");
        }
    }
}
